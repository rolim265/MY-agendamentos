<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendário Funcional - Aluguel de Chácara com PIX</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fff;
      color: #777;
      margin: 2rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .calendar {
      max-width: 400px;
      width: 100%;
    }
    .month-control {
      font-weight: 600;
      color: #222;
      background: #f7f7f7;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 1.5rem;
      padding: 0 1rem;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
      user-select: none;
      margin-bottom: 1.5rem;
      font-size: 1rem;
      width: fit-content;
    }
    .month-control button {
      all: unset;
      font-weight: 700;
      font-size: 1.2rem;
      color: #555;
      cursor: pointer;
      padding: 0 0.7rem;
      user-select: none;
      border-radius: 100%;
      transition: background-color 0.3s ease;
    }
    .month-control button:hover {
      background-color: #ddd;
    }
    .month-label {
      padding: 0 0.75rem;
      min-width: 11rem;
      text-align: center;
    }
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      font-weight: 600;
      font-size: 0.95rem;
      color: #777;
      margin-bottom: 0.6rem;
      user-select: none;
    }
    .weekdays div {
      text-align: center;
    }
    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.35rem;
    }
    .day {
      font-weight: 700;
      text-align: center;
      padding-top: 1.7rem;
      padding-bottom: 0.3rem;
      font-size: 1.1rem;
      border-radius: 0.4rem;
      position: relative;
      color: #b5b5b5;
      cursor: default;
      user-select: none;
      min-height: 45px;
    }
    .day.empty {
      cursor: default;
      background: transparent;
      pointer-events: none;
    }
    .day.active {
      color: #fff;
      background: #47b72b;
      border-radius: 0.4rem;
      cursor: pointer;
      user-select: none;
      line-height: 1.1rem;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding-top: 0.5rem;
      transition: background-color 0.3s ease;
    }
    .day.active:hover {
      background: #3d9f27;
    }
    .day.booked {
      background: #e63946;
      cursor: not-allowed;
      color: #fff;
    }
    .day .date-number {
      font-size: 1.3rem;
      margin-bottom: 0.1rem;
      font-weight: 700;
      user-select: text;
    }
    /* Popup */
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 5;
    }
    #overlay.show {
      display: block;
    }
    #popup {
      display: none;
      background: #fff;
      border-radius: 6px;
      padding: 20px;
      width: 90%;
      max-width: 420px;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      z-index: 10;
    }
    #popup.show {
      display: block;
    }
    #popup h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-weight: 700;
      color: #222;
    }
    #popup label {
      display: block;
      margin: 10px 0 5px;
    }
    #popup input,
    #popup textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1rem;
      resize: vertical;
    }
    #popup button {
      padding: 10px 15px;
      font-weight: 700;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #btn-agendar {
      background-color: #47b72b;
      color: #fff;
      margin-right: 10px;
    }
    #btn-cancelar {
      background-color: #aaa;
      color: #fff;
    }
    /* PIX area */
    #pix-area {
      margin-top: 15px;
      text-align: center;
    }
    #pixQr {
      max-width: 200px;
      margin-bottom: 10px;
    }
    #btn-pagamento-ok {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 700;
      margin-top: 10px;
    }
    #btn-pagamento-ok:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    /* Responsividade pequena */
    @media (max-width: 420px) {
      body {
        margin: 12px;
      }
      .month-label {
        min-width: 8rem;
      }
    }
  </style>
</head>
<body>

  <main class="calendar" role="main" aria-label="Calendário">
    <div class="month-control" aria-live="polite" aria-atomic="true">
      <button id="prev-month" aria-label="Mês anterior" type="button">&#x25C0;</button>
      <span class="month-label" id="month-label" aria-live="assertive" aria-atomic="true"></span>
      <button id="next-month" aria-label="Próximo mês" type="button">&#x25B6;</button>
    </div>
    <div class="weekdays" aria-hidden="true">
      <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sab</div><div>Dom</div>
    </div>
    <div class="days" id="days" role="list"></div>
  </main>

  <div id="overlay"></div>
  <div id="popup" role="dialog" aria-modal="true" aria-labelledby="popup-title">
    <h3 id="popup-title">Aluguel para <span id="popup-date"></span></h3>
    <form id="aluguel-form">
      <label for="nome">Nome completo</label>
      <input type="text" id="nome" name="nome" required />

      <label for="cpf">CPF</label>
      <input type="text" id="cpf" name="cpf" maxlength="14" placeholder="000.000.000-00" required />

      <label for="email">Email</label>
      <input type="email" id="email" name="email" required />

      <label for="telefone">Telefone</label>
      <input type="tel" id="telefone" name="telefone" />

      <label for="qtd-pessoas">Quantidade de pessoas</label>
      <input type="number" id="qtd-pessoas" name="qtd-pessoas" min="1" value="1" required />

      <label for="observacao">Observação (opcional)</label>
      <textarea id="observacao" name="observacao" rows="3" placeholder="Ex: Vou precisar da churrasqueira"></textarea>

      <button type="submit" id="btn-agendar">Confirmar aluguel (R$ 500)</button>
    </form>

    <div id="pix-area" style="display:none;">
      <img id="pixQr" alt="Código QR PIX" />
      <p id="pixCode" style="user-select: text; font-weight: bold;"></p>
      <button id="btn-pagamento-ok">Já realizei o pagamento</button>
    </div>

    <br />
    <button id="btn-cancelar">Cancelar</button>
  </div>

  <script>
    // Variáveis e elementos
    const form = document.getElementById('aluguel-form');
    const overlay = document.getElementById('overlay');
    const popup = document.getElementById('popup');
    const popupDateSpan = document.getElementById('popup-date');
    const btnCancelar = document.getElementById('btn-cancelar');
    const pixArea = document.getElementById('pix-area');
    const pixQr = document.getElementById('pixQr');
    const pixCode = document.getElementById('pixCode');
    const btnPagamentoOk = document.getElementById('btn-pagamento-ok');
    const monthLabel = document.getElementById('month-label');
    const daysContainer = document.getElementById('days');
    const prevBtn = document.getElementById('prev-month');
    const nextBtn = document.getElementById('next-month');

    let currentDate = new Date();
    currentDate.setDate(1);

    let alugueis = new Set();
    let selectedDate = null;
    let ultimoPagamentoId = null; // id do pagamento PIX gerado

    // Função para validar CPF
    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, '');
      if (cpf.length !== 11) return false;
      if (/^(.)\1+$/.test(cpf)) return false;

      let soma = 0, resto;
      for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.substring(9, 10))) return false;

      soma = 0;
      for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.substring(10, 11))) return false;

      return true;
    }

    // Função para formatar data yyyy-mm-dd
    function toISO(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    // Buscar alugueis do backend
    async function carregarAgendamentosBackend() {
      try {
        const res = await fetch('back/listar_agendamentos.php');
        const arr = await res.json();
        alugueis = new Set(arr.map(a => a.data));
      } catch (err) {
        console.error('Erro ao buscar agendamentos:', err);
        alugueis = new Set();
      }
    }

    // Renderiza calendário
    function renderCalendar() {
      daysContainer.innerHTML = '';
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      const monthsNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      monthLabel.textContent = `${monthsNames[month]} ${year}`;

      const firstDayWeek = new Date(year, month, 1).getDay();
      const startEmptyDays = (firstDayWeek === 0) ? 6 : firstDayWeek - 1;
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < startEmptyDays; i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.classList.add('day', 'empty');
        emptyDiv.setAttribute('role', 'listitem');
        emptyDiv.setAttribute('aria-disabled', 'true');
        daysContainer.appendChild(emptyDiv);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayDiv = document.createElement('div');
        dayDiv.classList.add('day');

        if (alugueis.has(dateStr)) {
          dayDiv.classList.add('booked');
          dayDiv.setAttribute('aria-disabled', 'true');
          dayDiv.textContent = day;
        } else {
          dayDiv.classList.add('active');
          dayDiv.setAttribute('role', 'listitem');
          dayDiv.setAttribute('tabindex', '0');
          dayDiv.innerHTML = `<span class="date-number">${day}</span>`;
          dayDiv.addEventListener('click', () => openPopup(dateStr));
          dayDiv.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              openPopup(dateStr);
            }
          });
        }

        daysContainer.appendChild(dayDiv);
      }
    }

    // Abrir popup
    function openPopup(dateStr) {
      selectedDate = dateStr;
      const [year, month, day] = dateStr.split('-');
      popupDateSpan.textContent = `${day}/${month}/${year}`;
      form.style.display = 'block';
      pixArea.style.display = 'none';
      form.reset();
      overlay.classList.add('show');
      popup.classList.add('show');
      document.getElementById('nome').focus();
      ultimoPagamentoId = null;
    }

    // Fechar popup
    function closePopup() {
      overlay.classList.remove('show');
      popup.classList.remove('show');
      selectedDate = null;
      ultimoPagamentoId = null;
    }

    btnCancelar.addEventListener('click', closePopup);
    overlay.addEventListener('click', closePopup);

    // Enviar formulário e gerar PIX
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!selectedDate) {
        alert('Selecione uma data antes.');
        return;
      }

      const nome = form.nome.value.trim();
      const cpf = form.cpf.value.replace(/\D/g, '').trim();
      const email = form.email.value.trim();
      const telefone = form.telefone.value.trim();
      const qtdPessoas = parseInt(form['qtd-pessoas'].value, 10) || 1;
      const observacao = form.observacao.value.trim();
      const valor = 500.00;

      if (!nome || !cpf || !email) {
        alert('Preencha os campos obrigatórios.');
        return;
      }

      if (!validarCPF(cpf)) {
        alert('CPF inválido!');
        form.cpf.focus();
        return;
      }

      // Gerar PIX pelo backend
      try {
        const res = await fetch('back/gerar_pix.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            valor,
            descricao: `Aluguel chácara ${nome} para o dia ${selectedDate}`
          })
        });

        const json = await res.json();

        if (json.error) {
          alert('Erro ao gerar PIX: ' + json.error);
          return;
        }

        // Mostrar PIX no popup
        pixArea.style.display = 'block';
        form.style.display = 'none';
        pixQr.src = "data:image/png;base64," + json.point_of_interaction.transaction_data.qr_code_base64;
        pixCode.textContent = json.point_of_interaction.transaction_data.qr_code;
        ultimoPagamentoId = json.id;

      } catch (err) {
        alert('Erro ao conectar com o servidor para gerar PIX.');
        console.error(err);
      }
    });

    // Confirmar pagamento
    btnPagamentoOk.addEventListener('click', async () => {
      if (!ultimoPagamentoId) {
        alert('Nenhum pagamento gerado para confirmar.');
        return;
      }

      try {
        const res = await fetch('back/verificar_pagamento.php?id=' + ultimoPagamentoId);
        const json = await res.json();

        if (json.status === 'approved') {
          alert('Pagamento confirmado! Seu aluguel está agendado.');
          closePopup();
          await carregarAgendamentosBackend();
          renderCalendar();
        } else if (json.status === 'pending') {
          alert('Pagamento ainda não confirmado. Aguarde alguns minutos e tente novamente.');
        } else {
          alert('Pagamento não realizado ou cancelado.');
        }
      } catch (err) {
        alert('Erro ao verificar pagamento.');
        console.error(err);
      }
    });

    prevBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    });

    nextBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    });

    // Inicializar
    (async () => {
      await carregarAgendamentosBackend();
      renderCalendar();
    })();

  </script>
</body>
</html>
